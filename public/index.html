<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aメニュー - 毎日の献立を考える負担から解放</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div id="app" class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- ヘッダー -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-utensils mr-2"></i>
                Aメニュー
            </h1>
            <p class="text-gray-600">
                考えなくていい、悩まなくていい。<br>
                今日から1ヶ月分の晩ごはんが決まります。
            </p>
        </header>

        <!-- チャットエリア -->
        <div id="chat-container" class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div id="messages" class="space-y-4 mb-6"></div>
            <div id="input-area"></div>
        </div>

        <!-- 献立カレンダー（生成後に表示） -->
        <div id="calendar-container" class="hidden bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="fas fa-calendar-alt mr-2"></i>
                1ヶ月分の献立
            </h2>
            <div id="calendar-content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        // アプリケーション状態
        const appState = {
            step: 0,
            data: {
                title: '',
                start_date: '',
                months: 1,
                members_count: 0,
                members: [],
                budget_tier_per_person: 500,
                budget_distribution: 'average',
                cooking_time_limit_min: 30,
                shopping_frequency: 'weekly',
                fish_frequency: 'normal',
                dislikes: [],
                allergies: { standard: [], free_text: [] }
            },
            planId: null
        };

        // 質問フロー
        const questions = [
            {
                id: 'welcome',
                type: 'message',
                text: 'こんにちは！Aメニューへようこそ。<br>いくつかの質問に答えるだけで、1ヶ月分の晩ごはん献立が完成します。<br><br>準備はいいですか？',
                options: [{ label: 'はじめる', value: 'start' }]
            },
            {
                id: 'title',
                type: 'text',
                text: 'この献立のタイトルを教えてください（例：「岩間家」「我が家の献立」）',
                field: 'title',
                placeholder: '献立のタイトル'
            },
            {
                id: 'start_date',
                type: 'date',
                text: 'いつから始めますか？',
                field: 'start_date'
            },
            {
                id: 'months',
                type: 'choice',
                text: '何ヶ月分作りますか？',
                field: 'months',
                options: [
                    { label: '1ヶ月', value: 1 },
                    { label: '2ヶ月', value: 2 },
                    { label: '3ヶ月', value: 3 }
                ]
            },
            {
                id: 'members_count',
                type: 'number',
                text: '家族は何人ですか？',
                field: 'members_count',
                min: 1,
                max: 10
            },
            {
                id: 'budget',
                type: 'choice',
                text: '1人あたりの平均予算を選んでください',
                field: 'budget_tier_per_person',
                options: [
                    { label: '300円（超節約）', value: 300 },
                    { label: '500円（節約）', value: 500 },
                    { label: '800円（標準）', value: 800 },
                    { label: '1000円（やや贅沢）', value: 1000 },
                    { label: '1200円（贅沢）', value: 1200 },
                    { label: '1500円（ご褒美）', value: 1500 }
                ]
            },
            {
                id: 'time',
                type: 'choice',
                text: '平日の調理時間の目安は？',
                field: 'cooking_time_limit_min',
                options: [
                    { label: '15分', value: 15 },
                    { label: '30分', value: 30 },
                    { label: '45分', value: 45 },
                    { label: '60分', value: 60 }
                ]
            },
            {
                id: 'allergies',
                type: 'multi-choice',
                text: 'アレルギーはありますか？（複数選択可）',
                field: 'allergies.standard',
                options: [
                    { label: 'なし', value: 'none' },
                    { label: '卵', value: 'egg' },
                    { label: '乳', value: 'milk' },
                    { label: '小麦', value: 'wheat' },
                    { label: 'えび', value: 'shrimp' },
                    { label: 'かに', value: 'crab' },
                    { label: 'そば', value: 'buckwheat' },
                    { label: '落花生', value: 'peanut' }
                ]
            },
            {
                id: 'confirm',
                type: 'confirm',
                text: 'これで1ヶ月分の献立を作成します。よろしいですか？',
                summary: true
            }
        ];

        // DOM要素
        const messagesEl = document.getElementById('messages');
        const inputAreaEl = document.getElementById('input-area');
        const calendarContainerEl = document.getElementById('calendar-container');
        const calendarContentEl = document.getElementById('calendar-content');

        // メッセージ追加
        function addMessage(text, isBot = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isBot ? 
                'flex items-start space-x-2' : 
                'flex items-start space-x-2 justify-end';
            
            const icon = isBot ? '<i class="fas fa-robot text-blue-500"></i>' : '<i class="fas fa-user text-green-500"></i>';
            const bgColor = isBot ? 'bg-blue-50' : 'bg-green-50';
            
            messageDiv.innerHTML = `
                ${isBot ? icon : ''}
                <div class="${bgColor} rounded-lg p-3 max-w-md">
                    <p class="text-gray-800">${text}</p>
                </div>
                ${!isBot ? icon : ''}
            `;
            
            messagesEl.appendChild(messageDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // 入力エリア作成
        function showInput(question) {
            inputAreaEl.innerHTML = '';

            if (question.type === 'message') {
                const btnContainer = document.createElement('div');
                btnContainer.className = 'flex gap-2';
                question.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600';
                    btn.textContent = opt.label;
                    btn.onclick = () => nextStep();
                    btnContainer.appendChild(btn);
                });
                inputAreaEl.appendChild(btnContainer);
            }
            else if (question.type === 'text') {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'w-full px-4 py-2 border rounded';
                input.placeholder = question.placeholder || '';
                
                const btn = document.createElement('button');
                btn.className = 'mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600';
                btn.textContent = '次へ';
                btn.onclick = () => {
                    if (input.value.trim()) {
                        appState.data[question.field] = input.value.trim();
                        addMessage(input.value, false);
                        nextStep();
                    }
                };
                
                inputAreaEl.appendChild(input);
                inputAreaEl.appendChild(btn);
            }
            else if (question.type === 'date') {
                const input = document.createElement('input');
                input.type = 'date';
                input.className = 'w-full px-4 py-2 border rounded';
                input.value = new Date().toISOString().split('T')[0];
                
                const btn = document.createElement('button');
                btn.className = 'mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600';
                btn.textContent = '次へ';
                btn.onclick = () => {
                    appState.data[question.field] = input.value;
                    addMessage(input.value, false);
                    nextStep();
                };
                
                inputAreaEl.appendChild(input);
                inputAreaEl.appendChild(btn);
            }
            else if (question.type === 'number') {
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'w-full px-4 py-2 border rounded';
                input.min = question.min || 1;
                input.max = question.max || 10;
                input.value = question.min || 1;
                
                const btn = document.createElement('button');
                btn.className = 'mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600';
                btn.textContent = '次へ';
                btn.onclick = () => {
                    appState.data[question.field] = parseInt(input.value);
                    // 家族構成の簡易初期化
                    if (question.field === 'members_count') {
                        appState.data.members = Array(parseInt(input.value)).fill(0).map(() => ({
                            gender: 'unknown',
                            age_band: 'adult'
                        }));
                    }
                    addMessage(input.value + '人', false);
                    nextStep();
                };
                
                inputAreaEl.appendChild(input);
                inputAreaEl.appendChild(btn);
            }
            else if (question.type === 'choice') {
                const btnContainer = document.createElement('div');
                btnContainer.className = 'flex flex-wrap gap-2';
                question.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'px-4 py-2 bg-gray-100 border rounded hover:bg-blue-100';
                    btn.textContent = opt.label;
                    btn.onclick = () => {
                        appState.data[question.field] = opt.value;
                        addMessage(opt.label, false);
                        nextStep();
                    };
                    btnContainer.appendChild(btn);
                });
                inputAreaEl.appendChild(btnContainer);
            }
            else if (question.type === 'multi-choice') {
                const selected = new Set();
                const btnContainer = document.createElement('div');
                btnContainer.className = 'flex flex-wrap gap-2 mb-2';
                
                question.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'px-4 py-2 bg-gray-100 border rounded hover:bg-blue-100';
                    btn.textContent = opt.label;
                    btn.onclick = () => {
                        if (opt.value === 'none') {
                            selected.clear();
                            btnContainer.querySelectorAll('button').forEach(b => b.classList.remove('bg-blue-200'));
                        } else {
                            if (selected.has(opt.value)) {
                                selected.delete(opt.value);
                                btn.classList.remove('bg-blue-200');
                            } else {
                                selected.add(opt.value);
                                btn.classList.add('bg-blue-200');
                            }
                        }
                    };
                    btnContainer.appendChild(btn);
                });
                
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600';
                confirmBtn.textContent = '次へ';
                confirmBtn.onclick = () => {
                    appState.data.allergies.standard = Array.from(selected).filter(v => v !== 'none');
                    const msg = selected.size === 0 || selected.has('none') ? 'なし' : Array.from(selected).join(', ');
                    addMessage(msg, false);
                    nextStep();
                };
                
                inputAreaEl.appendChild(btnContainer);
                inputAreaEl.appendChild(confirmBtn);
            }
            else if (question.type === 'confirm') {
                const summary = `
                    <div class="bg-gray-50 p-4 rounded mb-4">
                        <p><strong>タイトル:</strong> ${appState.data.title}</p>
                        <p><strong>開始日:</strong> ${appState.data.start_date}</p>
                        <p><strong>期間:</strong> ${appState.data.months}ヶ月</p>
                        <p><strong>人数:</strong> ${appState.data.members_count}人</p>
                        <p><strong>予算:</strong> ${appState.data.budget_tier_per_person}円/人</p>
                        <p><strong>調理時間:</strong> ${appState.data.cooking_time_limit_min}分</p>
                    </div>
                `;
                inputAreaEl.innerHTML = summary;
                
                const btn = document.createElement('button');
                btn.className = 'w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600';
                btn.textContent = '献立を作成する';
                btn.onclick = async () => {
                    btn.disabled = true;
                    btn.textContent = '生成中...';
                    await generatePlan();
                };
                inputAreaEl.appendChild(btn);
            }
        }

        // 次のステップへ
        function nextStep() {
            if (appState.step < questions.length - 1) {
                appState.step++;
                const question = questions[appState.step];
                addMessage(question.text);
                showInput(question);
            }
        }

        // 献立生成
        async function generatePlan() {
            try {
                // 1. 家族プロファイル作成
                const householdRes = await axios.post('/api/households', appState.data);
                const household_id = householdRes.data.household_id;

                addMessage('家族プロファイルを作成しました！');

                // 2. 献立生成
                const planRes = await axios.post('/api/plans/generate', { household_id });
                appState.planId = planRes.data.plan_id;

                addMessage('✨ 献立が完成しました！');
                
                // カレンダー表示
                document.getElementById('chat-container').classList.add('hidden');
                showCalendar(planRes.data.days);

            } catch (error) {
                console.error(error);
                addMessage('エラーが発生しました。もう一度お試しください。');
            }
        }

        // カレンダー表示
        function showCalendar(days) {
            calendarContainerEl.classList.remove('hidden');
            
            let html = '<div class="grid gap-4">';
            days.forEach(day => {
                const recipes = day.recipes || [];
                const main = recipes.find(r => r.role === 'main');
                const side = recipes.find(r => r.role === 'side');
                const soup = recipes.find(r => r.role === 'soup');

                html += `
                    <div class="border rounded-lg p-4 hover:shadow-md transition">
                        <div class="font-bold text-lg mb-2">${day.date}</div>
                        <div class="space-y-1 text-sm">
                            ${main ? `<p><span class="text-red-600">●</span> ${main.title}</p>` : ''}
                            ${side ? `<p><span class="text-green-600">●</span> ${side.title}</p>` : ''}
                            ${soup ? `<p><span class="text-blue-600">●</span> ${soup.title}</p>` : ''}
                        </div>
                        <div class="mt-2 text-xs text-gray-500">
                            <i class="far fa-clock"></i> ${day.estimated_time_min}分
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            calendarContentEl.innerHTML = html;
        }

        // 初期化
        window.addEventListener('DOMContentLoaded', () => {
            const question = questions[0];
            addMessage(question.text);
            showInput(question);
        });
    </script>
</body>
</html>
