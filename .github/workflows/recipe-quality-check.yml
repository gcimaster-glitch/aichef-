name: Recipe Quality Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/**/*.json'
      - 'db/**/*.sql'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'scripts/**/*.json'
      - 'db/**/*.sql'

jobs:
  duplicate-check:
    name: ãƒ¬ã‚·ãƒ”é‡è¤‡ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run duplicate check
        run: node scripts/check-duplicates.cjs
      
      - name: Comment on PR (if duplicate found)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **ãƒ¬ã‚·ãƒ”é‡è¤‡ãƒã‚§ãƒƒã‚¯å¤±æ•—**\n\né‡è¤‡ã¾ãŸã¯é¡žä¼¼åº¦ã®é«˜ã„ãƒ¬ã‚·ãƒ”ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚`scripts/check-duplicates.cjs`ã‚’å®Ÿè¡Œã—ã¦è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
            })
  
  recipe-validation:
    name: ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Validate recipe JSON
        run: |
          echo "ðŸ“‹ ãƒ¬ã‚·ãƒ”JSONãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼..."
          for file in scripts/*recipe*.json; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              node -e "JSON.parse(require('fs').readFileSync('$file', 'utf8'))" || exit 1
            fi
          done
          echo "âœ… å…¨ã¦ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ‰åŠ¹ã§ã™"
      
      - name: Check recipe structure
        run: |
          echo "ðŸ” ãƒ¬ã‚·ãƒ”æ§‹é€ ãƒã‚§ãƒƒã‚¯..."
          node -e "
          const fs = require('fs');
          const files = fs.readdirSync('scripts').filter(f => f.includes('recipe') && f.endsWith('.json'));
          
          let errors = [];
          files.forEach(file => {
            const data = JSON.parse(fs.readFileSync('scripts/' + file, 'utf8'));
            const recipes = Array.isArray(data) ? data : data.recipes || [];
            
            recipes.forEach((recipe, idx) => {
              if (!recipe.recipe_id) errors.push(\`\${file}: ãƒ¬ã‚·ãƒ”#\${idx} - recipe_id ãŒå¿…è¦\`);
              if (!recipe.title) errors.push(\`\${file}: ãƒ¬ã‚·ãƒ”#\${idx} - title ãŒå¿…è¦\`);
              if (!recipe.role || !['main', 'side', 'soup'].includes(recipe.role)) {
                errors.push(\`\${file}: ãƒ¬ã‚·ãƒ”#\${idx} - ç„¡åŠ¹ãªrole: \${recipe.role}\`);
              }
            });
          });
          
          if (errors.length > 0) {
            console.error('âŒ æ§‹é€ ã‚¨ãƒ©ãƒ¼:');
            errors.forEach(e => console.error('  ' + e));
            process.exit(1);
          }
          
          console.log('âœ… ãƒ¬ã‚·ãƒ”æ§‹é€ ã¯æ­£å¸¸ã§ã™');
          "
  
  sql-syntax-check:
    name: SQLæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SQLite
        run: sudo apt-get update && sudo apt-get install -y sqlite3
      
      - name: Validate SQL files
        run: |
          echo "ðŸ“‹ SQLãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡æ¤œè¨¼..."
          for file in db/*.sql migrations/*.sql 2>/dev/null; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              sqlite3 :memory: < "$file" || exit 1
            fi
          done
          echo "âœ… å…¨ã¦ã®SQLãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãŒæ­£å¸¸ã§ã™"
  
  quality-summary:
    name: å“è³ªã‚µãƒžãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [duplicate-check, recipe-validation, sql-syntax-check]
    if: always()
    
    steps:
      - name: Check overall status
        run: |
          echo "ðŸ“Š å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… é‡è¤‡ãƒã‚§ãƒƒã‚¯: ${{ needs.duplicate-check.result }}"
          echo "âœ… ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼: ${{ needs.recipe-validation.result }}"
          echo "âœ… SQLæ§‹æ–‡: ${{ needs.sql-syntax-check.result }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ "${{ needs.duplicate-check.result }}" == "failure" || 
                "${{ needs.recipe-validation.result }}" == "failure" || 
                "${{ needs.sql-syntax-check.result }}" == "failure" ]]; then
            echo "âŒ å“è³ªãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
          
          echo "âœ… å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸ"
